name: build

on:
  workflow_run:
    workflows: ["code-guard"]
    types: [completed]

env:
  NODE_VERSION: 18

permissions:
  contents: write
  actions: write

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4.1.6

      - name: Set up Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check for branch named after actor
        id: branchcheck
        run: |
          set -euo pipefail
          $ACTOR = "${{ github.event.workflow_run.actor.login || github.actor }}"
          $OWNER = "${{ github.repository_owner }}"
          $REPO_NAME = "${{ github.event.workflow_run.repository.name }}"
          Write-Host "Checking for branch refs/heads/$ACTOR in $OWNER/$REPO_NAME"

          # default to false
          echo "branch_exists=false" >> "$Env:GITHUB_OUTPUT"

          $respFile = "C:\windows\temp\branch_check_resp.json"
          $url = "https://api.github.com/repos/$OWNER/$REPO_NAME/branches/$ACTOR"
          $headers = @{ "Accept" = "application/vnd.github+json"; "Authorization" = "Bearer $env:GITHUB_TOKEN" }

          try {
            $r = Invoke-RestMethod -Uri $url -Headers $headers -Method Get -ErrorAction Stop -OutFile $respFile
            $httpCode = 200
          } catch {
            # If Invoke-RestMethod fails, inspect status code via Invoke-WebRequest
            try {
              $resp = Invoke-WebRequest -Uri $url -Headers $headers -Method Get -ErrorAction Stop -OutFile $respFile
              $httpCode = $resp.StatusCode.Value__
            } catch {
              if ($_.Exception.Response -ne $null) {
                $httpCode = $_.Exception.Response.StatusCode.value__
              } else {
                $httpCode = 0
              }
            }
          }

          Write-Host "Branch check HTTP code: $httpCode"
          echo "branch_http_code=$httpCode" >> "$Env:GITHUB_OUTPUT"

          if ($httpCode -eq 200) {
            echo "branch_exists=true" >> "$Env:GITHUB_OUTPUT"
            Write-Host "Branch exists"
          } elseif ($httpCode -eq 404) {
            Write-Host "Branch not found"
          } else {
            Write-Host "Unexpected HTTP code $httpCode"
            if (Test-Path $respFile) { Get-Content $respFile | Write-Host }
          }

      - name: Parse CODEOWNERS (select first email)
        id: parseowners
        run: |
          if (Test-Path CODEOWNERS) {
            (Select-String -Path CODEOWNERS -Pattern '[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}' -AllMatches |
              ForEach-Object { $_.Matches } | ForEach-Object { $_.Value }) |
              Sort-Object -Unique | Out-File -FilePath emails.txt -Encoding utf8
            if ((Get-Item emails.txt).Length -gt 0) {
              $first = Get-Content emails.txt | Select-Object -First 1
              Write-Host "Using first CODEOWNERS email: $first"
              echo "first_email=$first" >> "$Env:GITHUB_OUTPUT"
            } else {
              echo "first_email=" >> "$Env:GITHUB_OUTPUT"
            }
          } else {
            echo "first_email=" >> "$Env:GITHUB_OUTPUT"
          }
          $count = 0
          if (Test-Path emails.txt) { $count = (Get-Content emails.txt).Count }
          echo "emails_count=$count" >> "$Env:GITHUB_OUTPUT"

      - name: Conditional repository dispatch (only when branch exists)
        if: ${{ steps.branchcheck.outputs.branch_exists == 'true' && steps.parseowners.outputs.first_email != '' }}
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: triggerEmail
          client-payload: '{"email":"${{ steps.parseowners.outputs.first_email }}","meta":"build-ready"}'
          repository: ${{ github.repository }}

      - name: Log skip reason
        if: ${{ steps.branchcheck.outputs.branch_exists != 'true' || steps.parseowners.outputs.first_email == '' }}
        run: |
          Write-Host "Dispatch skipped. branch_exists=${{ steps.branchcheck.outputs.branch_exists }} first_email=${{ steps.parseowners.outputs.first_email }}"

      - name: Install and test
        run: |
          npm install
          npm run build --if-present
          npm run test --if-present
          npm prune --production

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4 # v4.3.3
        with:
          name: node-app
          path: .

      - name: Cleanup window (hold for 3 minutes)
        run: |
          Write-Host "Starting cleanup window â€” sleeping for 180 seconds to simulate cleanup."
          Start-Sleep -Seconds 180
